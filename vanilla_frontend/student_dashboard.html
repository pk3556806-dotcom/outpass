<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- QR Code Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container nav-content">
            <div class="nav-brand">CampusPass Student</div>
            <div class="nav-user">
                <span class="user-name-display">Student</span>
                <button onclick="logout()" class="btn btn-sm btn-outline">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2>My Dashboard</h2>
            <a href="student_apply.html" class="btn btn-primary btn-sm">Apply for Pass</a>
        </div>

        <div id="passes-container" class="dashboard-grid">
            <!-- Passes will be loaded here -->
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Protect Route
        const user = checkAuth('STUDENT');

        function renderPasses() {
            const passes = getPasses().filter(p => p.usn === user.usn);
            const container = document.getElementById('passes-container');
            container.innerHTML = '';

            if (passes.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">No pass requests found.</p>';
                return;
            }

            passes.forEach(pass => {
                const card = document.createElement('div');
                card.className = `pass-card ${pass.status.toLowerCase()}`;
                
                let qrCodeHtml = '';
                if (pass.status === 'APPROVED') {
                    qrCodeHtml = `<div id="qr-${pass.id}" class="mt-4" style="display: flex; justify-content: center;"></div>`;
                }

                card.innerHTML = `
                    <div class="pass-header">
                        <span class="pass-id">${pass.id}</span>
                        <span class="status-badge status-${pass.status.toLowerCase()}">${pass.status}</span>
                    </div>
                    <h3 style="margin-bottom: 1rem;">${pass.reason}</h3>
                    <div class="pass-details">
                        <div><strong>Date:</strong> ${pass.date}</div>
                        <div><strong>Time:</strong> ${pass.timeOut}</div>
                    </div>
                    ${qrCodeHtml}
                    ${pass.rejectionReason ? `<div style="margin-top: 1rem; color: var(--danger); font-size: 0.9rem;">Reason: ${pass.rejectionReason}</div>` : ''}
                `;
                
                container.appendChild(card);

                if (pass.status === 'APPROVED') {
                    setTimeout(() => {
                        new QRCode(document.getElementById(`qr-${pass.id}`), {
                            text: JSON.stringify({ passId: pass.id, usn: pass.usn }),
                            width: 128,
                            height: 128
                        });
                    }, 100);
                }
            });
        }

        renderPasses();
    </script>
</body>
</html>
