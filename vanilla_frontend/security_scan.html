<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Scanner</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container nav-content">
            <div class="nav-brand">Security Checkpoint</div>
            <div class="nav-user">
                <span class="user-name-display">Guard</span>
                <button onclick="logout()" class="btn btn-sm btn-outline">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div style="max-width: 500px; margin: 0 auto;">
            <div id="scan-result" class="card hidden" style="margin-bottom: 2rem; text-align: center;">
                <!-- Results shown here -->
            </div>

            <div class="card">
                <h2 class="text-center mb-4">Scan Pass QR</h2>
                <div id="reader"></div>
                <p class="text-center mt-4" style="color: var(--text-muted);">Point camera at student's QR code</p>
                <button id="reset-btn" onclick="startScanner()" class="btn btn-primary mt-4 hidden">Scan Another</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        checkAuth('SECURITY');

        let html5QrcodeScanner;

        function onScanSuccess(decodedText, decodedResult) {
            // Stop scanning
            html5QrcodeScanner.clear();
            document.getElementById('reset-btn').classList.remove('hidden');

            try {
                const data = JSON.parse(decodedText);
                validatePass(data.passId, data.usn);
            } catch (e) {
                showResult(false, "Invalid QR Format");
            }
        }

        function validatePass(passId, usn) {
            const passes = getPasses();
            const pass = passes.find(p => p.id === passId);

            if (!pass) {
                showResult(false, "Pass ID Not Found");
                return;
            }

            if (pass.usn !== usn) {
                showResult(false, "USN Mismatch! Security Alert!");
                return;
            }

            if (pass.status === 'APPROVED') {
                showResult(true, "Access Granted", pass);
                // Auto mark as used
                updatePassStatus(pass.id, 'USED');
            } else if (pass.status === 'USED') {
                showResult(false, "Pass Already Used");
            } else {
                showResult(false, `Pass Status: ${pass.status}`);
            }
        }

        function showResult(valid, message, pass = null) {
            const resultDiv = document.getElementById('scan-result');
            resultDiv.classList.remove('hidden');
            
            resultDiv.style.borderColor = valid ? 'var(--success)' : 'var(--danger)';
            resultDiv.style.backgroundColor = valid ? '#f0fdf4' : '#fef2f2';

            resultDiv.innerHTML = `
                <h1 style="color: ${valid ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 0.5rem;">
                    ${valid ? 'ALLOWED' : 'DENIED'}
                </h1>
                <p style="font-size: 1.2rem; font-weight: bold;">${message}</p>
                ${pass ? `<p class="mt-4">Student: ${pass.studentName} (${pass.usn})</p>` : ''}
            `;
        }

        function startScanner() {
            document.getElementById('scan-result').classList.add('hidden');
            document.getElementById('reset-btn').classList.add('hidden');

            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader",
                { fps: 10, qrbox: { width: 250, height: 250 } },
                /* verbose= */ false
            );
            html5QrcodeScanner.render(onScanSuccess, (error) => {
                // console.warn(error);
            });
        }

        // Initialize
        startScanner();
    </script>
</body>
</html>
